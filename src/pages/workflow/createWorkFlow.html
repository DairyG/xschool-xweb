<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8" />
		<title></title>
		<link rel="stylesheet" href="../../layui/css/layui.css" />
		<link rel="stylesheet" href="../../layui/css/common.css" />
		<link rel="stylesheet" href="../../layui/css/liucheng.css" />
		<script type="text/javascript" src="../../form/js/jquery-1.7.2.min.js"></script>
		<script type="text/javascript" src="../../layui/layui.js"></script>
		<script type="text/javascript" src="../../js/common.js"></script>
		<script type="text/javascript" src="../../js/service.js"></script>
		<link type="text/css" rel="stylesheet" href="../../form/css/common.css" />
		<link type="text/css" rel="stylesheet" href="../../form/css/jquery-ui-1.9.2.custom.css" />
		<link type="text/css" rel="stylesheet" href="../../form/css/widgets.css" />
		<link type="text/css" rel="stylesheet" href="../../form/css/jquery.mCustomScrollbar.min.css" />
		<link type="text/css" rel="stylesheet" href="../../form/css/formbuild.css" />
	</head>
	<script type="text/javascript">
		var M = {FRMNM: "表单名称",DESC: "",LANG: "cn",LBLAL: "T",CFMTYP: "T",CFMMSG: "提交成功。",SDMAIL: "0",CAPTCHA: "1",IPLMT: "0",SCHACT: "0",INSTR: "0",ISPUB: "1"};
		var F = [];
		var fieldsLimit=150;
		var goodsNumber=60;
		var imageNumber=10;
		var LVL=4;
		var isForTemplate=false;
		
	</script>
	<body class="bgf2f2f2">
		<div class="childrenBody">
			<div class="layui-card-body bgwhite">
				<div class="layui-tab" lay-filter="component-tabs-brief">
					<ul class="layui-tab-title">
						<li id="tab_index1" class="layui-this">基本信息</li>
						<li id="tab_index2">内容设计</li>
						<li>流程设计</li>
						<span class="layui-btn fr" onclick="history.back(-1)">返回</span>
					</ul>
					<div class="layui-tab-content">
						<div class="layui-tab-item layui-show" tab-name="基本信息">
							<form class="layui-form layui-form2">
								<div class="layui-row">
									<div class="layui-form-item layui-col-md12 margin-b-20 layui-form-item1">
										<label class="layui-form-label"><span class="text-red"> *</span>流程名称</label>
										<div class="layui-input-block">
											<input id="txtSubjectName" type="text" name="title" required  lay-verify="required" placeholder="请输入流程名称" autocomplete="off" class="layui-input">
										</div>
									</div>
									<div class="layui-form-item layui-col-md6 margin-b-20">
										<label class="layui-form-label"><span class="text-red"> *</span>流程类型</label>
										<div class="layui-input-block">
											<input type="radio" name="FlowTypeId" title="事务流程" lay-skin="primary" checked />
											<input type="radio" name="FlowTypeId" title="费用流程" lay-skin="primary" />

										</div>
									</div>
									<div class="layui-form-item layui-col-md6 margin-b-20">
										<label class="layui-form-label"><span class="text-red"> *</span>所属分组</label>
										<div class="layui-input-block">
											<select id="select_SubjectTypeId">
												
											</select>
										</div>
									</div>
									<div class="layui-form-item layui-col-md6 margin-b-20">
										<label class="layui-form-label"><span class="text-red"> *</span>可见范围</label>
										<div class="layui-input-block">
											<input type="text" name="title" id="RangeList" required  lay-verify="required" placeholder="请选择可见范围" autocomplete="off" class="layui-input" onclick="user_popup(this,'user,company,dpt_position,position,department')" readonly />
										</div>
									</div>
									<div class="layui-form-item layui-col-md6 margin-b-20">
										<label class="layui-form-label">流程图标</label>
										<div class="layui-input-block">
											<div class="margin-t-3">
												<span class="layui-btn layui-btn-sm layui-btn-normal">上传图标</span>
											</div>
										</div>
									</div>
									<div class="layui-form-item layui-col-md6 margin-b-20">
										<label class="layui-form-label">流程描述</label>
										<div class="layui-input-block">
											<input id="txtRemark" type="text" name="title" required  lay-verify="required" placeholder="请输入流程描述" autocomplete="off" class="layui-input">
										</div>
									</div>
									<div class="layui-form-item layui-col-md6 margin-b-20">
										<label class="layui-form-label">审批意见</label>
										<div class="layui-input-block">
											<input type="checkbox" title="必填" lay-skin="primary" name="PassInfo" value='1' />
										</div>
									</div>
								</div>
								<div class="layui-row text-right">
									<a class="layui-btn layui-btn-danger" onclick="$('#tab_index2').click()">下一步</a>
									<span class="layui-btn" onclick="history.back(-1)">返回</span>
								</div>
							</form>
						</div>
						<div class="layui-tab-item" tab-name="内容设计" id="build_container">
							
						</div>
						<div class="layui-tab-item" tab-name="流程设计">
							<form class="layui-form process_add_form">
								<div class="layui-form-item">
									<div style="width: 400px;margin:0 auto">
										<ul class="process_box">
											<li>
												<div class="layui-card faqi_card">
													<div class="layui-card-header">发起人</div>
													<div class="layui-card-body">
														<div class="show_div">
															所有人
														</div>
													</div>
												</div>
												<div class="process_add_btn_item">
													<label>
														<i class="layui-icon layui-icon-add-circle" onclick="show_add_item(this)"></i>
														<input type="radio" name="add_item_point" lay-ignore />
													</label>
												</div>
											</li>
											<li class="li_0">
												<div class="layui-card shenpi_card">
													<div class="layui-card-header">
														审批人
														<div class="fr">
															<input name="type_0" type="radio" value="false" title="或签" checked />
															<input name="type_0" type="radio" value="true" title="会签" />
														</div>
														<input type="hidden" name="PassType" value="1" />
													</div>
													<div class="layui-card-body">
														<div class="show_div">
															<span class="text-85">请选择审批人</span>															
														</div>
														<label class="add_icon text-85">
															<i class="layui-icon layui-icon-right fr fontsize-18"></i>
															<input type="radio" name="add_item_point" lay-ignore  onclick="on_select(this)"/>
														</label>
													</div>
												</div>
												<div class="process_add_btn_item">
													<label>
														<i class="layui-icon layui-icon-add-circle" onclick="show_add_item(this)"></i>
														<input type="radio" name="add_item_point" lay-ignore />
													</label>
												</div>
											</li>
											<li>
												<div class="layui-card cahosong_card">
													<div class="layui-card-header">
														抄送人<i class="layui-icon layui-icon-close-fill fr fontsize-18" onclick="close_item(this)"></i>
														<input type="hidden" name="PassType" value="2" />
													</div>
													<div class="layui-card-body">
														<!-- 一个人时显示 人名称 多个人时显示人数+会签（例 4人会签） -->
														<div class="show_div"><span class="text-85">请选择抄送人</span></div>
														<label class="add_icon text-85">
															<i class="layui-icon layui-icon-right fr fontsize-18"></i>
															<input type="radio" name="add_item_point" lay-ignore  onclick="on_select(this)"/>
														</label>
													</div>
												</div>
												<div class="process_add_btn_item">
													<label>
														<i class="layui-icon layui-icon-add-circle" onclick="show_add_item(this)"></i>
														<input type="radio" name="add_item_point" lay-ignore />
													</label>
												</div>
											</li>
											<li>
												<div class="layui-card fupan_card">
													<div class="layui-card-header">复盘人
														<input type="hidden" name="PassType" value="3" />
													</div>
													<div class="layui-card-body text-center">
														<input type="checkbox" name="UserId" value="1" title="发起人必填" lay-skin="primary" />
														<input type="checkbox" name="DepId" value="1" title="部门经理必填" lay-skin="primary"/>
													</div>
												</div>
												<div class="process_add_btn_item process_add_btn_item_end">
												</div>
												<p class="text-center text-85">流程结束</p>
											</li>
										</ul>
									</div>
								</div>
								<div class="layui-row text-right">
									<a class="layui-btn layui-btn-danger" href="javascript:void(0)" class="link_Save" onclick="save()" >确认</a>
									<span class="layui-btn" onclick="history.back(-1)">返回</span>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="linePop linePop1">
			<div class="layui-card-body padding-r-50">
				<form class="layui-form layui-form2" >
					<div class="layui-row">
						<div class="layui-form-item layui-col-md12 margin-b-20">
							<label class="layui-form-label"><span class="text-red"> *</span>分组名称</label>
							<div class="layui-input-block">
								<input type="text" name="title" required  lay-verify="required" placeholder="请输入分组名称" autocomplete="off" class="layui-input">
							</div>
						</div>
					</div>	
					<div class="layui-row text-right">
						<button class="layui-btn" lay-submit="" lay-filter="formDemo">确认</button>
						<span class="layui-btn layui-btn-primary" onclick="closePop()">返回</span>
					</div>
				</form>
			</div>
		</div>
		<div class="linePop linePop2">
			<div class="layui-card-body padding-r-50">
				<form class="layui-form layui-form2" >
					<div class="layui-row">
						<div class="layui-form-item layui-col-md12 margin-b-20">
							<label class="layui-form-label"><span class="text-red"> *</span>分组</label>
							<div class="layui-input-block">
								<select>
									<option></option>
									<option>用车申请</option>
									<option>请假申请</option>
									<option>资源申请</option>
									<option>用车申请</option>
									<option>请假申请</option>
									<option>资源申请</option>
									<option>用车申请</option>
									<option>请假申请</option>
									<option>资源申请</option>
								</select>
							</div>
						</div>
					</div>	
					<div class="layui-row text-right">
						<button class="layui-btn" lay-submit="" lay-filter="formDemo">确认</button>
						<span class="layui-btn layui-btn-primary" onclick="closePop()">返回</span>
					</div>
				</form>
			</div>
		</div>
		<script type="text/html" id="shenpi_html">
			<div class="layui-card shenpi_card">
				<div class="layui-card-header">审批人
					<div class="fr">
						<input name="type_{{d.index}}" type="radio" value="false" title="或签" checked />
						<input name="type_{{d.index}}" type="radio" value="true" title="会签" />
					</div>
					<input type="hidden" name="PassType" value="1" />
					<i class="layui-icon layui-icon-close-fill fr fontsize-18" onclick="close_item(this)"></i>
				</div>
				<div class="layui-card-body">
					<div class="show_div"><span class="text-85">请选择审批人</span></div>
					<label class="add_icon text-85">
						<i class="layui-icon layui-icon-right fr fontsize-18"></i>
						<input type="radio" name="add_item_point" lay-ignore  onclick="on_select(this)"/>
					</label>
				</div>
			</div>
			<div class="process_add_btn_item">
				<label>
					<i class="layui-icon layui-icon-add-circle" onclick="show_add_item(this)"></i>
					<input type="radio" name="add_item_point" lay-ignore />
				</label>
			</div>
		</script>
		<script type="text/html" id="chaosong_html">
			<div class="layui-card cahosong_card">
				<div class="layui-card-header">
					抄送人<i class="layui-icon layui-icon-close-fill fr fontsize-18" onclick="close_item(this)"></i>
					<input type="hidden" name="PassType" value="2" />
				</div>
				<div class="layui-card-body">
					<div class="show_div"><span class="text-85">请选择抄送人</span></div>
					<label class="add_icon text-85">
						<i class="layui-icon layui-icon-right fr fontsize-18"></i>
						<input type="radio" name="add_item_point" lay-ignore  onclick="on_select(this)"/>
					</label>
				</div>
			</div>
			<div class="process_add_btn_item">
				<label>
					<i class="layui-icon layui-icon-add-circle" onclick="show_add_item(this)"></i>
					<input type="radio" name="add_item_point" lay-ignore />
				</label>
			</div>
		</script>
		<div class="linePop linePop3" id="add_item" >
			<div class="layui-row add_item">
				<div class="layui-col-md6 text-center">
					<label href="javascript:;" onclick="add_item('shenpi')">
						<i class="layui-icon layui-icon-survey text-add"></i>
						<span>审批人</span>
					</label>
				</div>
				<div class="layui-col-md6 text-center">
					<label href="javascript:;" onclick="add_item('chaosong')">
						<i class="layui-icon layui-icon-release text-edit"></i>
						<span>抄送人</span>
					</label>
				</div>
			</div>
		</div>
		<div class="linePop linePop4" >
			<div class="layui-row add_item">
				<div class="layui-col-md6 text-center">
					<label href="javascript:;" onclick="user_popup(null,true,false,false,0,true)">
						<i class="layui-icon layui-icon-group text-add"></i>
						<span>指定成员</span>
					</label>
				</div>
				<div class="layui-col-md6 text-center">
					<label href="javascript:;" onclick="done_select('duty')">
						<i class="layui-icon layui-icon-friends text-edit"></i>
						<span>部门负责人</span>
					</label>
				</div>
			</div>
		</div>
		<script type="text/javascript" src="../../form/js/head.load.min.js"></script>
		<script type="text/javascript">
			$('#build_container').load('../public/form.html','',function(){
				head.js("../../form/js/jquery-ui-1.8.24.custom.min.js",
						"../../form/js/wangEditor.min.js",
						"../../form/js/utils.js",
						"../../form/js/widgets.js",
						"../../form/js/jquery.mCustomScrollbar.min.js",
						"../../form/js/formbuilder.js");
			});
			var layer_linePop,form,laytpl;
			layui.use(['table','element','form','laytpl'], function() {
				var table = layui.table,
					element = layui.element;
					form = layui.form;
				laytpl = layui.laytpl;
					
				loadSubjectTypes();
			});
			function add_group(){
				layer_linePop = layer.open({
					type: 1,
					title:'添加分组',
					String: false,
					closeBtn: 1,
					skin: 'layui-layer-rim',
					area: '750px',
					content: $('.linePop1')
				});
			}
			function process_move(){
				layer_linePop = layer.open({
					type: 1,
					title:'移动分组',
					String: false,
					closeBtn: 1,
					skin: 'layui-layer-rim',
					area: ['750px','450px'],
					content: $('.linePop2')
				});
			}
			function show_add_item(obj){
				layer_linePop = layer.open({
					type: 1,
					title:'添加流程项',
					String: false,
					closeBtn: 1,
					skin: 'layui-layer-rim',
					area: ['350px','160px'],
					content: $('.linePop3')
				});
			}
			function add_item(type){
				var tpl_html = $("#"+type+"_html").html();
				var index = $('#process_box li').length;
				var p_li = $("input[name='add_item_point']:checked").parents('li');
				laytpl(tpl_html).render({index:index+1}, function(html){
					$(p_li).after('<li>'+html+'</li>');
					closePop();
					form.render();
				});
			}
			function on_select(obj){
				var to_obj = $(obj).closest('.layui-card-body').find('.show_div');
				user_popup(to_obj,'user,company,dpt_position,position,department');
			}
			function done_select(type){
				if(type == 'duty'){//部门负责人
					var p_li = $("input[name='add_item_point']:checked").parents('li');
					$(p_li).find('.show_div').html('部门负责人');
				}
				closePop();
			}
			function close_item(obj){
				$(obj).parents('li').remove();
			}
			function closePop(){
				layer.close(layer_linePop);
			}
			//绑定流程组别
			function loadSubjectTypes()
			{

				Serv.Get('lc/SubjectType/GetSubjectTypeList',null,function(data){
					$("#select_SubjectTypeId").empty();
						$.each(data,function(index,item){
						
							if(index==0)
							{
								$("#select_SubjectTypeId").append("<option value=''>请选择分组</option>");
							}
                        var opt=$("<option value="+item.id+">"+item.subjectTypeName+"</option>")
                        $("#select_SubjectTypeId").append(opt);
					   });
					   form.render('select');
				},false);
				
			}
			function save()
			{
				var SubjectName=$("#txtSubjectName").val();
				var Remark=$("#txtRemark").val();
				var FlowTypeId=1;//$("input[name='FlowTypeId']:checked").val();
				var PassInfo = $("input[name='PassInfo']").prop('checked');
				var IcoUrl="";
				var SubjectTypeId=$("#select_SubjectTypeId").val();
				var FormContent = JSON.stringify(F);
				var FormAttribute = JSON.stringify(M);
				var RangeList = $('#RangeList').siblings('input').val();
				var subjectRuleRangeList = RangeList ? formart_sels(RangeList,1) : [];
				
				var subjectStepFlowList = [];
				$('.process_box li').each(function(i,obj){
					//节点类型
					var PassType = $(obj).find('input[name="PassType"]').val();
						PassType = parseInt(PassType);
						var d = {
							"passNo": i,
							"passName": "string",
							"isEnd": false,
							"isCountersign": false,
							"passType": 1,
							"subjectRulePassList": []
						};
					var UserId = 0,DepId = 0;
					switch(PassType){
						case 1://审批
							d.passName = '审批人';
							d.isCountersign = $(obj).find('.layui-card-header input[type="radio"]:checked').val();
							d.isCountersign = d.isCountersign == 'true' ? true : false;						
							break;
						case 2://抄送
							d.passName = '抄送人';
							break;
						case 3://复盘
							if($(obj).find('input[name="UserId"]').prop('checked')){
								UserId = $(obj).find('input[name="UserId"]').val();
								d.isEnd = true;
							}
							if($(obj).find('input[name="DepId"]').prop('checked')){
								DepId = $(obj).find('input[name="DepId"]').val();
								d.isEnd = true;
							}
							
							d.passName = '复盘人';
							break;	
					}
					d.passType = PassType;
					var RulePassList = $(obj).find('.show_div input[name="sels"]').val();
					d.subjectRulePassList = RulePassList ? formart_sels(RulePassList,2) : [];
					if(PassType == 3){//复盘节点 - 并且至少选择了一项
						var s = {
							businessType:2,
							dataType:0,
							companyId:0,
							depId:parseInt(DepId),
							userId:parseInt(UserId),
							jobDepId:0,
							jobId:0
						}
						d.subjectRulePassList.push(s);
						if(UserId > 0 || DepId > 0){
							subjectStepFlowList.push(d);
						} else {
							var prev_index = subjectStepFlowList.length;
								prev_index = prev_index - 1;
							subjectStepFlowList[prev_index].isEnd = true;
						}
					} else if(PassType > 0){
						subjectStepFlowList.push(d);
					}
				});
				var data={
					"SubjectName":SubjectName,
					"Remark":Remark,
					"FlowTypeId":parseInt(FlowTypeId),
					"PassInfo":PassInfo,
					"IcoUrl":IcoUrl,
					"SubjectTypeId":SubjectTypeId,
					"FormContent":FormContent,
					"FormAttribute":FormAttribute,
					"subjectRuleRangeList":subjectRuleRangeList,
					"subjectStepFlowList":subjectStepFlowList,
				};
				if(data.SubjectName.trim() == ""){
					layer.msg('流程名称不能为空!');
					$('#tab_index1').click();
					$("#txtSubjectName").focus();
					return false;
				}
				if(parseInt(data.FlowTypeId) <= 0 ){
					layer.msg('请选择流程类型！');
					$('#tab_index1').click();
					return false;
				}
				if(data.subjectRuleRangeList.length <= 0){
					layer.msg('请选择可见范围！');
					$('#tab_index1').click();
					return false;
				}
				if(parseInt(SubjectTypeId) <= 0 ){
					layer.msg('请选择所属分组！');
					$('#tab_index1').click();
					return false;
				}
				if(FormContent.length <= 0 ){
					layer.msg('表单项不能为空！');
					$('#tab_index2').click();
					return false;
				}
				var flag = false;
				for(var i = 0;i < subjectStepFlowList.length;i++){
					if(subjectStepFlowList[i].subjectRulePassList.length == 0 && subjectStepFlowList[i].passType != 3){
						var li = i+2;
						layer.msg('节点'+li+'：'+subjectStepFlowList[i].passName+'请选择人员');
						flag = true;
						return false;
					}
				}
				if(flag){
					return false;
				}
				console.log(data);
				layer.load();
				$(".link_Save").attr({"disabled":"true"});
				Serv.Post('lc/Subject/Add',data,function(resultData){
					console.log(resultData);
					$(".link_Save").attr({"disabled":"fasle"});
					layer.closeAll('loading');			
					if(resultData.succeed)
					{
						layer.msg('成功...', {icon:1});
					}else{
						layer.msg('失败:'+resultData.message, {icon:2});
					}
				},true)
			}
			
		</script>
	</body>
</html>